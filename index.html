<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZenFlow - Guided Breathing & Mindfulness</title>
    <meta name="description" content="Find your calm with ZenFlow, a free tool for guided breathing exercises, personalized themes, progress tracking, and mindful programs.">
    <meta name="keywords" content="breathing exercises, guided breathing, mindfulness, meditation, stress relief, progress tracking, themes, achievements, programs">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Tone.js for sound generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <!-- Chart.js for progress dashboard -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Custom Styles & Theme Configuration -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.5s, color 0.5s;
        }
        #animator {
            transition-property: transform, opacity;
            transition-timing-function: linear;
        }
        .custom-focus:focus-visible {
            outline: 2px solid var(--primary-400);
            outline-offset: 2px;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--slate-100); }
        ::-webkit-scrollbar-thumb { background: var(--slate-400); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--slate-500); }
        .screen, #share-sidebar { transition: opacity 0.5s ease-in-out; }
        
        /* Theme Variables */
        :root {
            --primary-400: #60a5fa; --primary-500: #3b82f6; --primary-600: #2563eb; --primary-700: #1d4ed8;
            --slate-50: #f8fafc; --slate-100: #f1f5f9; --slate-200: #e2e8f0; --slate-300: #cbd5e1; --slate-400: #94a3b8; --slate-500: #64748b; --slate-600: #475569; --slate-700: #334155; --slate-800: #1e293b; --slate-900: #0f172a;
            --body-bg: var(--slate-50); --body-text: var(--slate-800);
        }
        .dark {
            --body-bg: var(--slate-900); --body-text: var(--slate-200);
            --slate-50: #0f172a; --slate-100: #1e293b; --slate-200: #334155; --slate-300: #475569; --slate-400: #64748b; --slate-500: #94a3b8; --slate-600: #cbd5e1; --slate-700: #e2e8f0; --slate-800: #f1f5f9; --slate-900: #f8fafc;
        }
        body.theme-forest {
            --primary-400: #4ade80; --primary-500: #22c55e; --primary-600: #16a34a; --primary-700: #15803d;
        }
        body.theme-ocean {
            --primary-400: #38bdf8; --primary-500: #0ea5e9; --primary-600: #0284c7; --primary-700: #0369a1;
        }
        body.theme-sunset {
            --primary-400: #fb923c; --primary-500: #f97316; --primary-600: #ea580c; --primary-700: #c2410c;
        }

        /* Dynamic Color Classes */
        .bg-primary-100 { background-color: var(--primary-400); opacity: 0.1; }
        .bg-primary-600 { background-color: var(--primary-600); } .hover\:bg-primary-700:hover { background-color: var(--primary-700); }
        .text-primary-600 { color: var(--primary-600); } .dark .text-primary-400 { color: var(--primary-400); }
        .border-primary-500:focus { border-color: var(--primary-500); } .ring-primary-500:focus { --tw-ring-color: var(--primary-500); }
        .animator-gradient { background-image: linear-gradient(to bottom right, var(--primary-400), var(--primary-600)); }
        .text-amber-500 { color: #f59e0b; }
        .fill-primary-600 { fill: var(--primary-600); } .dark .fill-primary-400 { fill: var(--primary-400); }

        /* Achievement Notification */
        #achievement-toast {
            transition: transform 0.5s ease-in-out, opacity 0.5s ease-in-out;
            transform: translateY(200%);
        }
        #achievement-toast.show {
            transform: translateY(0);
        }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-200">

    <div id="app" class="min-h-screen flex flex-col items-center justify-center p-4 sm:p-6 lg:p-8 pb-24">
        <header id="main-header" class="absolute top-0 left-0 right-0 p-4 flex justify-end items-center">
            <button id="theme-toggle" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 custom-focus">
                <svg id="sun-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>
                <svg id="moon-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="hidden"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>
            </button>
        </header>

        <div id="main-screen" class="screen w-full flex flex-col items-center justify-center">
            <main class="flex flex-col items-center justify-center w-full max-w-2xl text-center flex-grow">
                <div class="text-center mb-8">
                    <div class="flex justify-center items-center gap-2">
                        <svg width="48" height="48" viewBox="0 0 24 24" class="fill-primary-600 dark:fill-primary-400">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10c.89 0 1.75-.12 2.56-.34.3-.08.54-.36.54-.66v-1.63c0-.38-.22-.72-.57-.88a8.01 8.01 0 0 1-1.99-.45c-2.76-.64-4.86-3.08-4.86-5.99C7.7 8.01 9.71 6 12.25 6c1.48 0 2.8.72 3.63 1.82.4.52 1.01.83 1.67.83h1.22c.41 0 .78-.25.93-.63C20.48 6.9 21.5 5.05 21.5 3c0-.55-.45-1-1-1h-8.5z"/>
                        </svg>
                        <h1 class="text-5xl font-bold text-slate-800 dark:text-slate-100 tracking-tight">ZenFlow</h1>
                    </div>
                    <p class="text-slate-500 dark:text-slate-400 mt-2">Your moment of calm</p>
                </div>
                <div class="w-full max-w-md space-y-6">
                    <div>
                        <label for="technique" class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-2">Breathing Technique</label>
                        <select id="technique" class="w-full px-4 py-3 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-lg shadow-sm appearance-none focus:outline-none focus:ring-2 ring-primary-500 border-primary-500 custom-focus"></select>
                    </div>
                    <div id="custom-timings" class="hidden grid grid-cols-3 gap-4 p-4 bg-slate-100 dark:bg-slate-800/50 rounded-lg">
                        <div><label for="inhale-time" class="block text-xs font-medium text-center">Inhale</label><input type="number" id="inhale-time" value="4" min="1" max="20" class="w-full mt-1 p-2 text-center rounded-md bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 custom-focus"></div>
                        <div><label for="hold-time" class="block text-xs font-medium text-center">Hold</label><input type="number" id="hold-time" value="4" min="0" max="20" class="w-full mt-1 p-2 text-center rounded-md bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 custom-focus"></div>
                        <div><label for="exhale-time" class="block text-xs font-medium text-center">Exhale</label><input type="number" id="exhale-time" value="4" min="1" max="20" class="w-full mt-1 p-2 text-center rounded-md bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 custom-focus"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label for="duration" class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-2">Session Duration</label><select id="duration" class="w-full px-4 py-3 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-lg shadow-sm appearance-none focus:outline-none focus:ring-2 ring-primary-500 border-primary-500 custom-focus"><option value="60">1 Minute</option><option value="120">2 Minutes</option><option value="300" selected>5 Minutes</option><option value="600">10 Minutes</option><option value="Infinity">Continuous</option></select></div>
                        <div><label for="sound" class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-2">Sound Guide</label><select id="sound" class="w-full px-4 py-3 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-lg shadow-sm appearance-none focus:outline-none focus:ring-2 ring-primary-500 border-primary-500 custom-focus"><option value="off">Off</option><option value="chime">Chime</option><option value="bowl">Singing Bowl</option></select></div>
                    </div>
                     <div class="grid grid-cols-2 gap-4">
                        <div><label for="theme-select" class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-2">Color Theme</label><select id="theme-select" class="w-full px-4 py-3 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-lg shadow-sm appearance-none focus:outline-none focus:ring-2 ring-primary-500 border-primary-500 custom-focus"><option value="default">Default</option><option value="forest">Forest</option><option value="ocean">Ocean</option><option value="sunset">Sunset</option></select></div>
                        <div><label for="background-sound" class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-2">Background Sound</label><select id="background-sound" class="w-full px-4 py-3 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-lg shadow-sm appearance-none focus:outline-none focus:ring-2 ring-primary-500 border-primary-500 custom-focus"><option value="off">Off</option><option value="rain">Gentle Rain</option><option value="fire">Crackling Fire</option></select></div>
                    </div>
                    <button id="start-stop-btn" class="w-full py-4 px-6 text-lg font-semibold text-white bg-primary-600 hover:bg-primary-700 rounded-lg shadow-lg transform hover:scale-105 transition-transform duration-200 custom-focus">Start Session</button>
                </div>
            </main>
        </div>
        
        <div id="session-screen" class="screen absolute inset-0 w-full h-full flex flex-col items-center justify-center opacity-0 pointer-events-none">
            <div id="animator-container" class="relative w-64 h-64 sm:w-80 sm:h-80 flex items-center justify-center mb-8">
                <div id="animator" class="animator-gradient absolute w-full h-full rounded-full opacity-20"></div>
                <div class="relative z-10 text-center">
                    <p id="instruction-text" class="text-2xl sm:text-3xl font-semibold text-slate-700 dark:text-slate-100">Ready?</p>
                    <!-- FIX: Changed text color for better contrast across all themes -->
                    <p id="countdown-text" class="text-5xl sm:text-6xl font-bold text-slate-800 dark:text-slate-100 mt-2"></p>
                </div>
            </div>
            <button id="stop-btn-session" class="mt-8 px-6 py-2 bg-slate-200 dark:bg-slate-700 rounded-full text-sm font-medium hover:bg-slate-300 dark:hover:bg-slate-600 custom-focus">Stop</button>
        </div>
    </div>

    <!-- Floating Share Sidebar -->
    <aside id="share-sidebar" class="fixed top-1/2 right-0 -translate-y-1/2 flex flex-col gap-2 bg-white/80 dark:bg-slate-900/80 backdrop-blur-sm p-2 rounded-l-lg border border-r-0 border-slate-200 dark:border-slate-700">
        <a href="https://twitter.com/intent/tweet?text=Find%20your%20calm%20with%20ZenFlow,%20a%20free%20mindfulness%20breathing%20app.&url=https://zenflow.app" target="_blank" class="p-2 text-slate-600 dark:text-slate-300 hover:text-primary-600 dark:hover:text-primary-400 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors">
            <svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
        </a>
        <a href="https://www.facebook.com/sharer/sharer.php?u=https://zenflow.app" target="_blank" class="p-2 text-slate-600 dark:text-slate-300 hover:text-primary-600 dark:hover:text-primary-400 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors">
            <svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor"><path d="M14 13.5h2.5l1-4H14v-2c0-1.03 0-2 2-2h1.5V2.14c-.326-.043-1.557-.14-2.857-.14C11.928 2 10 3.657 10 6.7v2.8H7v4h3V22h4z"/></svg>
        </a>
        <a href="https://api.whatsapp.com/send?text=Find%20your%20calm%20with%20ZenFlow,%20a%20free%20mindfulness%20breathing%20app.%20https://zenflow.app" target="_blank" class="p-2 text-slate-600 dark:text-slate-300 hover:text-primary-600 dark:hover:text-primary-400 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors">
            <svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor"><path d="M12.04 2c-5.46 0-9.91 4.45-9.91 9.91 0 1.75.46 3.45 1.32 4.95L2.05 22l5.25-1.38c1.45.79 3.08 1.21 4.74 1.21 5.46 0 9.91-4.45 9.91-9.91S17.5 2 12.04 2zM12.04 20.15c-1.48 0-2.93-.4-4.2-1.15l-.3-.18-3.12.82.83-3.04-.2-.31c-.82-1.31-1.26-2.83-1.26-4.38 0-4.54 3.7-8.24 8.24-8.24 2.2 0 4.27.86 5.82 2.42 1.56 1.56 2.42 3.63 2.42 5.82-1.87 4.55-6.25 4.55-8.24 4.55zm4.52-6.55c-.27-.13-1.59-.78-1.84-.88-.25-.09-.43-.13-.62.13-.19.27-.7.88-.86 1.06-.16.18-.32.2-.6.06-.27-.13-1.14-.42-2.17-1.33-.81-.72-1.36-1.61-1.52-1.88-.16-.27-.02-.42.12-.55.12-.12.27-.3.4-.46.13-.16.18-.27.27-.46.09-.18.04-.36-.02-.5-.07-.13-.61-1.47-.84-2.01-.23-.54-.46-.46-.62-.46h-.52c-.19 0-.48.09-.73.36-.25.27-1 .98-1 2.4 0 1.42 1.02 2.79 1.17 3 .15.2 2 3.2 4.84 4.26.68.27 1.22.43 1.64.56.7.2 1.34.18 1.84.1.58-.09 1.59-.65 1.81-1.28.23-.63.23-1.17.16-1.28z"/></svg>
        </a>
        <button id="copy-link-btn" class="p-2 text-slate-600 dark:text-slate-300 hover:text-primary-600 dark:hover:text-primary-400 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors">
            <svg id="copy-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            <svg id="check-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="hidden text-green-500"><polyline points="20 6 9 17 4 12"></polyline></svg>
        </button>
    </aside>

    <!-- Bottom Navigation -->
    <nav id="bottom-nav" class="fixed bottom-0 left-0 right-0 bg-white/80 dark:bg-slate-900/80 backdrop-blur-sm border-t border-slate-200 dark:border-slate-700">
        <div class="max-w-md mx-auto flex justify-around items-center h-16">
            <button data-modal="programs-modal" class="modal-trigger flex flex-col items-center text-slate-600 dark:text-slate-300 hover:text-primary-600 dark:hover:text-primary-400 custom-focus">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg>
                <span class="text-xs font-medium">Programs</span>
            </button>
            <button data-modal="progress-modal" class="modal-trigger flex flex-col items-center text-slate-600 dark:text-slate-300 hover:text-primary-600 dark:hover:text-primary-400 custom-focus">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
                <span class="text-xs font-medium">Progress</span>
            </button>
            <button data-modal="about-modal" class="modal-trigger flex flex-col items-center text-slate-600 dark:text-slate-300 hover:text-primary-600 dark:hover:text-primary-400 custom-focus">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
                <span class="text-xs font-medium">About</span>
            </button>
        </div>
    </nav>

    <!-- Modals -->
    <div id="about-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden"><div class="bg-white dark:bg-slate-800 rounded-lg shadow-2xl w-full max-w-2xl"><div class="p-6 border-b border-slate-200 dark:border-slate-700"><h3 class="text-xl font-semibold">About ZenFlow</h3><button class="absolute top-4 right-4 text-slate-500 hover:text-slate-800 dark:hover:text-slate-200 modal-close">&times;</button></div><div class="p-6 space-y-4"><p>ZenFlow is a simple, beautiful, and free tool designed to help you find calm and focus through the power of guided breathing. In our fast-paced world, taking a few moments to center yourself can make a world of difference.</p></div></div></div>
    <div id="congrats-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white dark:bg-slate-800 rounded-lg shadow-2xl w-full max-w-md text-center p-8">
            <h3 class="text-2xl font-bold text-primary-600 dark:text-primary-400">Well Done!</h3>
            <p class="mt-2 text-slate-600 dark:text-slate-300" id="session-summary-text"></p>
            <div class="mt-6 bg-slate-100 dark:bg-slate-700/50 p-4 rounded-lg"><p class="text-sm font-medium text-slate-500 dark:text-slate-400">DAILY STREAK</p><p class="text-4xl font-bold text-amber-500" id="streak-count"></p></div>
            <div class="flex gap-4 mt-6">
                <button id="share-btn" class="flex-1 py-3 px-4 text-md font-semibold text-primary-600 bg-primary-100 hover:bg-primary-200/50 rounded-lg custom-focus">Share</button>
                <button id="close-congrats-modal" class="flex-1 py-3 px-6 text-md font-semibold text-white bg-primary-600 hover:bg-primary-700 rounded-lg custom-focus">Continue</button>
            </div>
        </div>
    </div>
    <div id="progress-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white dark:bg-slate-800 rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-slate-200 dark:border-slate-700 sticky top-0 bg-white dark:bg-slate-800"><h3 class="text-xl font-semibold">Your Progress</h3><button class="absolute top-4 right-4 text-slate-500 hover:text-slate-800 dark:hover:text-slate-200 modal-close">&times;</button></div>
            <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-slate-100 dark:bg-slate-800/50 p-4 rounded-lg text-center"><p class="text-sm font-medium text-slate-500 dark:text-slate-400">Total Minutes</p><p id="total-minutes-stat" class="text-3xl font-bold text-primary-600 dark:text-primary-400"></p></div>
                <div class="bg-slate-100 dark:bg-slate-800/50 p-4 rounded-lg text-center"><p class="text-sm font-medium text-slate-500 dark:text-slate-400">Longest Streak</p><p id="longest-streak-stat" class="text-3xl font-bold text-primary-600 dark:text-primary-400"></p></div>
                <div class="md:col-span-2"><canvas id="technique-chart"></canvas></div>
            </div>
        </div>
    </div>
    <div id="programs-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white dark:bg-slate-800 rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
             <div class="p-6 border-b border-slate-200 dark:border-slate-700 sticky top-0 bg-white dark:bg-slate-800"><h3 class="text-xl font-semibold">Mindfulness Programs</h3><button class="absolute top-4 right-4 text-slate-500 hover:text-slate-800 dark:hover:text-slate-200 modal-close">&times;</button></div>
             <div id="programs-list" class="p-6 space-y-4"></div>
        </div>
    </div>
    
    <!-- Achievement Toast -->
    <div id="achievement-toast" class="fixed bottom-20 left-1/2 -translate-x-1/2 bg-slate-800 dark:bg-slate-100 text-white dark:text-slate-800 py-3 px-6 rounded-full shadow-lg opacity-0">
        <p>üèÜ Badge Unlocked: <span id="achievement-name"></span></p>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Element References ---
            const mainScreen = document.getElementById('main-screen'), sessionScreen = document.getElementById('session-screen'), animator = document.getElementById('animator'), instructionText = document.getElementById('instruction-text'), countdownText = document.getElementById('countdown-text'), startStopBtn = document.getElementById('start-stop-btn'), stopBtnSession = document.getElementById('stop-btn-session'), techniqueSelect = document.getElementById('technique'), durationSelect = document.getElementById('duration'), soundSelect = document.getElementById('sound'), customTimingsDiv = document.getElementById('custom-timings'), inhaleInput = document.getElementById('inhale-time'), holdInput = document.getElementById('hold-time'), exhaleInput = document.getElementById('exhale-time'), themeToggle = document.getElementById('theme-toggle'), sunIcon = document.getElementById('sun-icon'), moonIcon = document.getElementById('moon-icon'), congratsModal = document.getElementById('congrats-modal'), closeCongratsModalBtn = document.getElementById('close-congrats-modal'), sessionSummaryText = document.getElementById('session-summary-text'), streakCountText = document.getElementById('streak-count'), progressModal = document.getElementById('progress-modal'), totalMinutesStat = document.getElementById('total-minutes-stat'), longestStreakStat = document.getElementById('longest-streak-stat'), techniqueChartCanvas = document.getElementById('technique-chart'), programsModal = document.getElementById('programs-modal'), programsList = document.getElementById('programs-list'), achievementToast = document.getElementById('achievement-toast'), achievementName = document.getElementById('achievement-name'), themeSelect = document.getElementById('theme-select'), backgroundSoundSelect = document.getElementById('background-sound'), shareBtn = document.getElementById('share-btn'), bottomNav = document.getElementById('bottom-nav'), shareSidebar = document.getElementById('share-sidebar'), copyLinkBtn = document.getElementById('copy-link-btn'), copyIcon = document.getElementById('copy-icon'), checkIcon = document.getElementById('check-icon');
            
            // --- State & Config ---
            let isRunning = false, sessionInterval, animationInterval, totalTime, timeRemaining, currentPhaseIndex, phaseCountdown, lastSessionInfo = {}, techniqueChart;
            let backgroundPlayer;

            const breathingPatterns = {
                box: { name: 'Box Breathing', phases: [{ name: 'Inhale', duration: 4 }, { name: 'Hold', duration: 4 }, { name: 'Exhale', duration: 4 }, { name: 'Hold', duration: 4 }] },
                478: { name: '4-7-8 Breathing', phases: [{ name: 'Inhale', duration: 4 }, { name: 'Hold', duration: 7 }, { name: 'Exhale', duration: 8 }] },
                mindful: { name: 'Mindful Breathing', phases: [{ name: 'Inhale', duration: 5 }, { name: 'Exhale', duration: 5 }] },
                pursed: { name: 'Pursed Lip Breathing', phases: [{ name: 'Inhale', duration: 4 }, { name: 'Exhale', duration: 6 }] },
                custom: { name: 'Custom', phases: [] }
            };

            const programs = {
                intro: { name: "5-Day Intro to Mindfulness", days: [ { day: 1, technique: 'mindful' }, { day: 2, technique: 'box' }, { day: 3, technique: 'mindful' }, { day: 4, technique: 'pursed' }, { day: 5, technique: '478' } ] },
                stress: { name: "7-Day Stress Relief", days: [ { day: 1, technique: '478' }, { day: 2, technique: 'pursed' }, { day: 3, technique: 'mindful' }, { day: 4, technique: 'box' }, { day: 5, technique: '478' }, { day: 6, technique: 'mindful' }, { day: 7, technique: 'pursed' } ] },
                focus: { name: "3-Day Focus Boost", days: [ { day: 1, technique: 'box' }, { day: 2, technique: 'mindful' }, { day: 3, technique: 'box' } ] }
            };

            const achievements = {
                firstSession: { name: "First Step", criteria: (history) => history.length >= 1 },
                fiveSessions: { name: "Mindful Habit", criteria: (history) => history.length >= 5 },
                threeDayStreak: { name: "Consistency is Key", criteria: (history, stats) => stats.longestStreak >= 3 },
            };

            // --- Sound Synthesis ---
            let synth;
            const soundOptions = {
                chime: () => new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.01, decay: 0.5, sustain: 0.1, release: 1 } }).toDestination(),
                bowl: () => new Tone.MetalSynth({ frequency: 200, envelope: { attack: 0.01, decay: 1.4, release: 0.2 }, harmonicity: 5.1, modulationIndex: 32, resonance: 4000, octaves: 1.5 }).toDestination()
            };
            const backgroundSounds = {
                rain: () => new Tone.NoiseSynth({ noise: { type: 'brown' }, envelope: { attack: 0.5, decay: 0, sustain: 1 } }).toDestination(),
                fire: () => new Tone.NoiseSynth({ noise: { type: 'pink' }, envelope: { attack: 0.005, decay: 0.1, sustain: 0 } }).toDestination()
            };

            // --- Local Storage & Data ---
            const getStoredData = (key, defaultValue) => JSON.parse(localStorage.getItem(key)) || defaultValue;
            const setStoredData = (key, value) => localStorage.setItem(key, JSON.stringify(value));

            // --- Screen Management ---
            const showScreen = (screenToShow) => {
                const screens = [mainScreen, sessionScreen];
                screens.forEach(screen => {
                    if (screen.id === screenToShow) {
                        screen.classList.remove('opacity-0', 'pointer-events-none');
                    } else {
                        screen.classList.add('opacity-0', 'pointer-events-none');
                    }
                });
                bottomNav.classList.toggle('hidden', screenToShow === 'session-screen');
                shareSidebar.classList.toggle('hidden', screenToShow === 'session-screen');
            };

            // --- Core Functions ---
            const startSession = async (options = {}) => {
                if (Tone.context.state !== 'running') {
                    await Tone.start();
                }

                if (options.technique) {
                    techniqueSelect.value = options.technique;
                    if (techniqueSelect.value !== 'custom') customTimingsDiv.classList.add('hidden');
                }
                isRunning = true;
                showScreen('session-screen');
                const pattern = getSelectedPattern();
                const durationText = durationSelect.options[durationSelect.selectedIndex].text;
                lastSessionInfo = { technique: pattern.name, duration: durationText, durationSeconds: parseInt(durationSelect.value) };
                totalTime = durationSelect.value === 'Infinity' ? Infinity : parseInt(durationSelect.value);
                timeRemaining = totalTime;
                currentPhaseIndex = -1;
                if (soundSelect.value !== 'off') synth = soundOptions[soundSelect.value]();
                if (backgroundSoundSelect.value !== 'off') {
                    backgroundPlayer = backgroundSounds[backgroundSoundSelect.value]();
                    if(backgroundSoundSelect.value === 'rain') backgroundPlayer.triggerAttack();
                }
                nextPhase();
                if (totalTime !== Infinity) {
                    if(sessionInterval) clearInterval(sessionInterval);
                    sessionInterval = setInterval(() => {
                        if (!isRunning) return clearInterval(sessionInterval);
                        timeRemaining--;
                        if (timeRemaining < 0) stopSession(true);
                    }, 1000);
                }
            };

            const stopSession = (completed = false) => {
                isRunning = false;
                clearInterval(sessionInterval);
                clearInterval(animationInterval);
                if (backgroundPlayer) {
                    if(backgroundSoundSelect.value === 'rain') backgroundPlayer.triggerRelease();
                    backgroundPlayer = null;
                }
                showScreen('main-screen');
                animator.style.transitionDuration = '2s';
                animator.style.transform = 'scale(0.3)';
                animator.style.opacity = '0.2';
                if (completed) handleSessionCompletion();
            };

            const nextPhase = () => {
                if (!isRunning) return;
                const pattern = getSelectedPattern();
                currentPhaseIndex = (currentPhaseIndex + 1) % pattern.phases.length;
                const currentPhase = pattern.phases[currentPhaseIndex];
                instructionText.textContent = currentPhase.name;
                phaseCountdown = currentPhase.duration;
                updateAnimator(currentPhase.name, currentPhase.duration);
                playSound();
                if (backgroundSoundSelect.value === 'fire' && backgroundPlayer) backgroundPlayer.triggerAttackRelease("C1", "8n", Tone.now(), Math.random() * 0.5 + 0.5);
                countdownText.textContent = phaseCountdown;
                if (animationInterval) clearInterval(animationInterval);
                animationInterval = setInterval(() => {
                    if (!isRunning) return clearInterval(animationInterval);
                    phaseCountdown--;
                    countdownText.textContent = phaseCountdown > 0 ? phaseCountdown : '';
                    if (phaseCountdown <= 0) {
                        clearInterval(animationInterval);
                        nextPhase();
                    }
                }, 1000);
            };

            const handleSessionCompletion = () => {
                const history = getStoredData('zenFlowHistory', []);
                history.push({ date: new Date().toISOString(), ...lastSessionInfo });
                setStoredData('zenFlowHistory', history);
                const stats = calculateStats(history);
                updateProgramProgress();
                checkAchievements(history, stats);
                sessionSummaryText.textContent = `You completed ${lastSessionInfo.duration} of ${lastSessionInfo.technique}.`;
                streakCountText.innerHTML = `üî• ${stats.currentStreak}`;
                congratsModal.classList.remove('hidden');
            };

            // --- UI & Event Handlers ---
            startStopBtn.addEventListener('click', () => startSession());
            stopBtnSession.addEventListener('click', () => stopSession(false));
            techniqueSelect.addEventListener('change', () => customTimingsDiv.classList.toggle('hidden', techniqueSelect.value !== 'custom'));
            
            const applyTheme = (isDark) => {
                document.documentElement.classList.toggle('dark', isDark);
                sunIcon.classList.toggle('hidden', isDark);
                moonIcon.classList.toggle('hidden', !isDark);
            };

            themeToggle.addEventListener('click', () => {
                const isDark = !document.documentElement.classList.contains('dark');
                localStorage.setItem('themeMode', isDark ? 'dark' : 'light');
                applyTheme(isDark);
                updateChartTheme();
            });

            themeSelect.addEventListener('change', (e) => {
                document.body.className = document.body.className.replace(/theme-\w+/g, '');
                if(e.target.value !== 'default') document.body.classList.add(`theme-${e.target.value}`);
                setStoredData('colorTheme', e.target.value);
            });
            shareBtn.addEventListener('click', () => {
                const text = `I just completed a ${lastSessionInfo.duration} mindfulness session with ZenFlow! My daily streak is ${streakCountText.innerText}.`;
                if(navigator.share) {
                    navigator.share({ title: 'My ZenFlow Progress', text: text }).catch(console.error);
                } else {
                    navigator.clipboard.writeText(text).then(() => alert('Copied to clipboard!'));
                }
            });
            copyLinkBtn.addEventListener('click', () => {
                navigator.clipboard.writeText(window.location.href).then(() => {
                    copyIcon.classList.add('hidden');
                    checkIcon.classList.remove('hidden');
                    setTimeout(() => {
                        copyIcon.classList.remove('hidden');
                        checkIcon.classList.add('hidden');
                    }, 2000);
                }).catch(err => console.error('Failed to copy text: ', err));
            });

            // --- Initialization ---
            function initializeApp() {
                // Populate techniques
                Object.keys(breathingPatterns).forEach(key => {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = breathingPatterns[key].name + (key.match(/\d+/) ? ` (${key.replace('box', '4-4-4-4')})` : '');
                    if (key === 'custom') option.textContent = 'Custom';
                    techniqueSelect.appendChild(option);
                });

                // Load saved theme
                const savedThemeMode = localStorage.getItem('themeMode');
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                applyTheme(savedThemeMode === 'dark' || (!savedThemeMode && prefersDark));
                
                const savedColorTheme = getStoredData('colorTheme', 'default');
                themeSelect.value = savedColorTheme;
                if(savedColorTheme !== 'default') document.body.classList.add(`theme-${savedColorTheme}`);
                
                // Modals
                document.querySelectorAll('.modal-trigger').forEach(trigger => {
                    trigger.addEventListener('click', () => {
                        const modalId = trigger.getAttribute('data-modal');
                        document.getElementById(modalId).classList.remove('hidden');
                        if (modalId === 'progress-modal') renderProgressDashboard();
                        if (modalId === 'programs-modal') renderPrograms();
                    });
                });
                document.querySelectorAll('.modal-close, .fixed[id$="-modal"]').forEach(el => {
                    el.addEventListener('click', (e) => {
                        if (e.target === el) el.closest('.fixed').classList.add('hidden');
                    });
                });
                closeCongratsModalBtn.addEventListener('click', () => congratsModal.classList.add('hidden'));
            }

            // --- Feature Implementations ---
            const playSound = () => {
                if (soundSelect.value === 'off' || !synth) return;
                
                if (soundSelect.value === 'chime') {
                    synth.triggerAttackRelease('C5', '8n');
                }
                if (soundSelect.value === 'bowl') {
                    synth.triggerAttackRelease('C4', '1n');
                }
            };
            const updateAnimator = (phaseName, duration) => {
                animator.style.transitionDuration = `${duration}s`;
                if (phaseName.toLowerCase().includes('inhale')) { animator.style.transform = 'scale(1)'; animator.style.opacity = '0.7'; } 
                else if (phaseName.toLowerCase().includes('exhale')) { animator.style.transform = 'scale(0.3)'; animator.style.opacity = '0.2'; }
            };
            const getSelectedPattern = () => {
                const selected = techniqueSelect.value;
                if (selected === 'custom') {
                    const inhale = parseInt(inhaleInput.value) || 4, hold = parseInt(holdInput.value) || 0, exhale = parseInt(exhaleInput.value) || 4;
                    let phases = [{ name: 'Inhale', duration: inhale }];
                    if (hold > 0) phases.push({ name: 'Hold', duration: hold });
                    phases.push({ name: 'Exhale', duration: exhale });
                    return { name: 'Custom Breathing', phases };
                }
                return breathingPatterns[selected];
            };
            const calculateStats = (history) => {
                const totalMinutes = history.reduce((acc, session) => acc + (session.durationSeconds / 60), 0);
                let currentStreak = 0, longestStreak = 0, lastDate = null;
                const dates = [...new Set(history.map(s => new Date(s.date).toDateString()))].sort((a,b) => new Date(a) - new Date(b));
                if (dates.length > 0) {
                    currentStreak = 1;
                    longestStreak = 1;
                    lastDate = new Date(dates[0]);
                    for (let i = 1; i < dates.length; i++) {
                        const currentDate = new Date(dates[i]);
                        const diffDays = (currentDate - lastDate) / (1000 * 60 * 60 * 24);
                        if (diffDays === 1) {
                            currentStreak++;
                        } else if (diffDays > 1) {
                            currentStreak = 1;
                        }
                        if (currentStreak > longestStreak) longestStreak = currentStreak;
                        lastDate = currentDate;
                    }
                    const today = new Date();
                    const lastSessionDate = new Date(dates[dates.length - 1]);
                    if ((today - lastSessionDate) / (1000 * 60 * 60 * 24) > 1) currentStreak = 0;
                }
                return { totalMinutes: Math.round(totalMinutes), currentStreak, longestStreak };
            };
            const renderProgressDashboard = () => {
                const history = getStoredData('zenFlowHistory', []);
                const stats = calculateStats(history);
                totalMinutesStat.textContent = stats.totalMinutes;
                longestStreakStat.textContent = `üî• ${stats.longestStreak}`;
                const techniqueCounts = history.reduce((acc, session) => {
                    acc[session.technique] = (acc[session.technique] || 0) + 1;
                    return acc;
                }, {});
                if (techniqueChart) techniqueChart.destroy();
                const chartData = {
                    labels: Object.keys(techniqueCounts),
                    datasets: [{ label: 'Sessions', data: Object.values(techniqueCounts), borderWidth: 1, backgroundColor: ['#3b82f6', '#16a34a', '#f97316', '#8b5cf6', '#ec4899'] }]
                };
                techniqueChart = new Chart(techniqueChartCanvas, { type: 'pie', data: chartData, options: { responsive: true, plugins: { legend: { position: 'top' } } } });
                updateChartTheme();
            };
            const updateChartTheme = () => {
                if(!techniqueChart) return;
                const isDark = document.documentElement.classList.contains('dark');
                techniqueChart.options.plugins.legend.labels.color = isDark ? '#f1f5f9' : '#1e293b';
                techniqueChart.update();
            };
            const renderPrograms = () => {
                const progress = getStoredData('zenFlowPrograms', {});
                programsList.innerHTML = '';
                Object.keys(programs).forEach(key => {
                    const program = programs[key];
                    const currentDay = progress[key]?.currentDay || 0;
                    const isComplete = currentDay >= program.days.length;
                    let programHTML = `<div class="p-4 border rounded-lg ${isComplete ? 'border-green-500' : 'border-slate-300 dark:border-slate-600'}">
                        <h4 class="font-bold">${program.name} ${isComplete ? '(Completed)' : ''}</h4>
                        <div class="flex mt-2 overflow-x-auto gap-2 pb-2">`;
                    program.days.forEach((day, index) => {
                        const dayComplete = index < currentDay;
                        programHTML += `<div class="text-center p-2 rounded-lg border-2 ${dayComplete ? 'bg-primary-100 border-primary-500' : 'bg-slate-100 dark:bg-slate-700 border-slate-200 dark:border-slate-600'}">
                            <p class="text-xs">Day ${day.day}</p>
                            <p class="font-semibold text-sm">${breathingPatterns[day.technique].name}</p>
                        </div>`;
                    });
                    programHTML += `</div>`;
                    if(!isComplete) {
                        programHTML += `<button data-program="${key}" data-day-technique="${program.days[currentDay].technique}" class="start-program-btn mt-4 w-full py-2 px-4 text-sm font-semibold text-white bg-primary-600 hover:bg-primary-700 rounded-lg custom-focus">Start Day ${currentDay + 1}</button>`;
                    }
                    programHTML += `</div>`;
                    programsList.innerHTML += programHTML;
                });
                document.querySelectorAll('.start-program-btn').forEach(btn => btn.addEventListener('click', (e) => {
                    const { program, dayTechnique } = e.target.dataset;
                    programsModal.classList.add('hidden');
                    startSession({ technique: dayTechnique });
                }));
            };
            const updateProgramProgress = () => {
                document.querySelectorAll('.start-program-btn').forEach(btn => {
                    if (lastSessionInfo.technique === breathingPatterns[btn.dataset.dayTechnique].name) {
                        const programKey = btn.dataset.program;
                        const progress = getStoredData('zenFlowPrograms', {});
                        if (!progress[programKey]) progress[programKey] = { currentDay: 0 };
                        progress[programKey].currentDay++;
                        setStoredData('zenFlowPrograms', progress);
                    }
                });
            };
            const checkAchievements = (history, stats) => {
                const unlocked = getStoredData('unlockedAchievements', {});
                Object.keys(achievements).forEach(key => {
                    if (!unlocked[key] && achievements[key].criteria(history, stats)) {
                        unlocked[key] = true;
                        showAchievement(achievements[key].name);
                    }
                });
                setStoredData('unlockedAchievements', unlocked);
            };
            const showAchievement = (name) => {
                achievementName.textContent = name;
                achievementToast.classList.add('show', 'opacity-100');
                setTimeout(() => {
                    achievementToast.classList.remove('show', 'opacity-100');
                }, 4000);
            };

            initializeApp();
        });
    </script>
</body>
</html>
